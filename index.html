<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Sunday School Exam System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    const { useState, useEffect, useCallback, createElement: h } = React;
    const { createRoot } = ReactDOM;

    // ===== GITHUB CONFIGURATION =====
    // Replace these with your actual values
    const GITHUB_CONFIG = {
      username: 'xaviersandeshb',  // Replace with your GitHub username
      repo: 'sunday_school_exams',
      token: '',  // Replace with your personal access token
      branch: 'main'
    };

    function ExamSystem() {
      const [view, setView] = useState('login');
      const [studentName, setStudentName] = useState('');
      const [examName, setExamName] = useState('');
      const [examData, setExamData] = useState(null);
      const [currentQuestion, setCurrentQuestion] = useState(0);
      const [answers, setAnswers] = useState({});
      const [timeLeft, setTimeLeft] = useState(0);
      const [examStarted, setExamStarted] = useState(false);
      const [allResults, setAllResults] = useState([]);
      const [isAdmin, setIsAdmin] = useState(false);
      const [isSpeaking, setIsSpeaking] = useState(false);
      const [availableExams, setAvailableExams] = useState([]);
      const [isUploading, setIsUploading] = useState(false);
      const adminPassword = 'admin123';
      const [passwordInput, setPasswordInput] = useState('');

      // Load results from localStorage
      useEffect(() => {
        try {
          const resultsResult = localStorage.getItem('all-results');
          if (resultsResult) {
            setAllResults(JSON.parse(resultsResult));
          }
        } catch (error) {
          console.error('Error loading results:', error);
        }
      }, []);

      // Save results to localStorage
      useEffect(() => {
        if (allResults.length > 0) {
          try {
            localStorage.setItem('all-results', JSON.stringify(allResults));
          } catch (err) {
            console.error('Failed to save results:', err);
          }
        }
      }, [allResults]);

      // Fetch available exams from GitHub
      const fetchAvailableExams = useCallback(async () => {
        try {
          const url = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/exams?ref=${GITHUB_CONFIG.branch}`;
          const response = await fetch(url);

          if (response.ok) {
            const files = await response.json();
            const jsonFiles = files
              .filter(file => file.name.endsWith('.json'))
              .map(file => ({
                name: file.name.replace('.json', ''),
                downloadUrl: file.download_url
              }));
            setAvailableExams(jsonFiles);
          }
        } catch (error) {
          console.error('Failed to fetch exams:', error);
        }
      }, []);

      // Load exam from GitHub by name
      // const loadExamFromGitHub = async (examFileName) => {
      //   try {
      //     const url = `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/exams/${examFileName}.json`;
      //     const response = await fetch(url);

      //     if (response.ok) {
      //       const json = await response.json();
      //       if (json.questions && json.questions.length > 0) {
      //         setExamData(json);
      //         return true;
      //       }
      //     }
      //     return false;
      //   } catch (error) {
      //     console.error('Failed to load exam:', error);
      //     return false;
      //   }
      // };
      // Load exam from GitHub by name
      const loadExamFromGitHub = async (examFileName) => {
        try {
          const url = `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/exams/${examFileName}.json`;
          const response = await fetch(url);
          
          if (response.ok) {
            const json = await response.json();
            if (json.questions && json.questions.length > 0) {
              setExamData(json);
              return json; // Return the exam data instead of true
            }
          }
          return null; // Return null instead of false
        } catch (error) {
          console.error('Failed to load exam:', error);
          return null;
        }
      };

      // Upload JSON file to GitHub
      const uploadToGitHub = async (fileName, content) => {
        try {
          setIsUploading(true);

          const url = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/exams/${fileName}`;

          // Check if file exists
          let sha = null;
          try {
            const checkResponse = await fetch(url, {
              headers: {
                'Authorization': `token ${GITHUB_CONFIG.token}`
              }
            });
            if (checkResponse.ok) {
              const existingFile = await checkResponse.json();
              sha = existingFile.sha;
            }
          } catch (e) {
            // File doesn't exist, that's okay
          }

          const body = {
            message: `${sha ? 'Update' : 'Add'} exam: ${fileName}`,
            content: btoa(unescape(encodeURIComponent(content))),
            branch: GITHUB_CONFIG.branch
          };

          if (sha) {
            body.sha = sha;
          }

          const response = await fetch(url, {
            method: 'PUT',
            headers: {
              'Authorization': `token ${GITHUB_CONFIG.token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
          });

          setIsUploading(false);

          if (response.ok) {
            await fetchAvailableExams();
            return true;
          } else {
            const error = await response.json();
            console.error('GitHub API error:', error);
            return false;
          }
        } catch (error) {
          setIsUploading(false);
          console.error('Upload error:', error);
          return false;
        }
      };

      const speakQuestion = (text) => {
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();

          if (isSpeaking) {
            setIsSpeaking(false);
            return;
          }

          const utterance = new SpeechSynthesisUtterance(text);
          utterance.rate = 0.9;
          utterance.pitch = 1;
          utterance.volume = 1;

          utterance.onstart = () => setIsSpeaking(true);
          utterance.onend = () => setIsSpeaking(false);
          utterance.onerror = () => setIsSpeaking(false);

          window.speechSynthesis.speak(utterance);
        }
      };

      useEffect(() => {
        return () => {
          if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
          }
        };
      }, [currentQuestion]);

      const handleLogin = async (e) => {
        if (e) e.preventDefault();

        if (!studentName.trim()) {
          alert('Please enter your name');
          return;
        }

        if (studentName.toLowerCase() === 'admin') {
          setView('admin-password');
          return;
        }

        // Student login - go to exam selection
        setView('exam-selection');
      };

      // const handleExamSelection = async (e) => {
      //   if (e) e.preventDefault();

      //   if (!examName.trim()) {
      //     alert('Please enter exam name');
      //     return;
      //   }

      //   const success = await loadExamFromGitHub(examName);

      //   if (success) {
      //     setView('exam');
      //     setTimeLeft(examData.duration * 60 || 1800);
      //     setExamStarted(true);
      //     setAnswers({});
      //     setCurrentQuestion(0);
      //   } else {
      //     alert(`Exam "${examName}" not found. Please check the exam name and try again.`);
      //   }
      // };

    const handleExamSelection = async (e) => {
      if (e) e.preventDefault();
      
      if (!examName.trim()) {
        alert('Please enter exam name');
        return;
      }

      const loadedExam = await loadExamFromGitHub(examName);
      
      if (loadedExam) {
        // Use the returned exam data directly to set timer
        const durationInSeconds = (loadedExam.duration || 30) * 60;
        setTimeLeft(durationInSeconds);
        setExamStarted(true);
        setAnswers({});
        setCurrentQuestion(0);
        setView('exam');
      } else {
        alert(`Exam "${examName}" not found. Please check the exam name and try again.`);
      }
    };


      const handleAdminLogin = () => {
        if (passwordInput === adminPassword) {
          setIsAdmin(true);
          setView('admin');
          setPasswordInput('');
          fetchAvailableExams();
        } else {
          alert('Incorrect password!');
        }
      };

      const handleFileUpload = async (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = async (event) => {
            try {
              const content = event.target.result;
              const json = JSON.parse(content);

              if (!json.examName || !json.questions || json.questions.length === 0) {
                alert('Invalid JSON format. Please check your file.');
                return;
              }

              // Create filename from exam name
              const fileName = json.examName.toLowerCase().replace(/[^a-z0-9]+/g, '-') + '.json';

              const success = await uploadToGitHub(fileName, content);

              if (success) {
                alert(`Exam "${json.examName}" uploaded successfully to GitHub!\nFilename: ${fileName}\nStudents can now access it.`);
              } else {
                alert('Failed to upload exam to GitHub. Please check your token and try again.');
              }
            } catch (error) {
              alert('Error reading file. Please upload a valid JSON file.');
              console.error(error);
            }
          };
          reader.readAsText(file);
        }
      };

      const clearAllResults = () => {
        if (confirm('Are you sure you want to delete ALL student results? This cannot be undone!')) {
          setAllResults([]);
          try {
            localStorage.removeItem('all-results');
            alert('All results cleared!');
          } catch (error) {
            console.error('Failed to clear results:', error);
          }
        }
      };

      const handleAnswerSelect = (questionIndex, optionIndex) => {
        setAnswers({ ...answers, [questionIndex]: optionIndex });
      };

      const calculateScore = () => {
        if (!examData || !examData.questions) {
          return { score: 0, total: 0, percentage: '0.00' };
        }

        let correct = 0;
        examData.questions.forEach((q, index) => {
          if (answers[index] === q.correct) {
            correct++;
          }
        });
        return {
          score: correct,
          total: examData.questions.length,
          percentage: ((correct / examData.questions.length) * 100).toFixed(2)
        };
      };

      const handleSubmit = useCallback(() => {
        if (!examData) return;

        setExamStarted(false);
        const result = calculateScore();

        const newResult = {
          examName: examData.examName || 'Untitled Exam',
          studentName: studentName,
          marks: `${result.score}/${result.total}`,
          percentage: result.percentage,
          timestamp: new Date().toLocaleString()
        };

        const updatedResults = [...allResults, newResult];

        const sortedResults = [...updatedResults].sort((a, b) => 
          parseFloat(b.percentage) - parseFloat(a.percentage)
        );

        const resultsWithRank = updatedResults.map(r => ({
          ...r,
          rank: sortedResults.findIndex(sr => 
            sr.studentName === r.studentName && sr.timestamp === r.timestamp
          ) + 1
        })).sort((a, b) => a.rank - b.rank);

        setAllResults(resultsWithRank);
        setView('results');
      }, [examData, studentName, allResults, answers]);

      useEffect(() => {
        if (examStarted && timeLeft > 0) {
          const timer = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
          return () => clearTimeout(timer);
        } else if (examStarted && timeLeft === 0) {
          handleSubmit();
        }
      }, [timeLeft, examStarted, handleSubmit]);

      const exportToExcel = () => {
        if (typeof XLSX === 'undefined') {
          alert('Excel export library not loaded. Please refresh the page and try again.');
          return;
        }

        if (allResults.length === 0) {
          alert('No results to export.');
          return;
        }

        try {
          const worksheet = XLSX.utils.json_to_sheet(allResults);
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, 'Results');
          XLSX.writeFile(workbook, `Sunday_School_Exam_Results.xlsx`);
        } catch (error) {
          console.error('Export error:', error);
          alert('Failed to export results. Please try again.');
        }
      };

      const formatTime = (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      };

      const resetApp = () => {
        setView('login');
        setStudentName('');
        setExamName('');
        setExamData(null);
        setCurrentQuestion(0);
        setAnswers({});
        setTimeLeft(0);
        setExamStarted(false);
        setIsAdmin(false);
        setPasswordInput('');
      };

      // SVG Icons
      const icons = {
        clock: h('svg', {width:24,height:24,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2},
          h('circle',{cx:12,cy:12,r:10}),
          h('polyline',{points:'12 6 12 12 16 14'})
        ),
        upload: h('svg', {width:20,height:20,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2},
          h('path',{d:'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4'}),
          h('polyline',{points:'17 8 12 3 7 8'}),
          h('line',{x1:12,y1:3,x2:12,y2:15})
        ),
        check: h('svg', {width:24,height:24,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2},
          h('path',{d:'M22 11.08V12a10 10 0 1 1-5.93-9.14'}),
          h('polyline',{points:'22 4 12 14.01 9 11.01'})
        ),
        alert: h('svg', {width:24,height:24,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2},
          h('circle',{cx:12,cy:12,r:10}),
          h('line',{x1:12,y1:8,x2:12,y2:12}),
          h('line',{x1:12,y1:16,x2:12.01,y2:16})
        ),
        download: h('svg', {width:20,height:20,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2},
          h('path',{d:'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4'}),
          h('polyline',{points:'7 10 12 15 17 10'}),
          h('line',{x1:12,y1:15,x2:12,y2:3})
        ),
        users: h('svg', {width:40,height:40,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2},
          h('path',{d:'M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2'}),
          h('circle',{cx:9,cy:7,r:4}),
          h('path',{d:'M23 21v-2a4 4 0 0 0-3-3.87'}),
          h('path',{d:'M16 3.13a4 4 0 0 1 0 7.75'})
        ),
        volume: h('svg', {width:24,height:24,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2},
          h('polygon',{points:'11 5 6 9 2 9 2 15 6 15 11 19 11 5'}),
          h('path',{d:'M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07'})
        ),
        volumeX: h('svg', {width:24,height:24,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2},
          h('polygon',{points:'11 5 6 9 2 9 2 15 6 15 11 19 11 5'}),
          h('line',{x1:23,y1:9,x2:17,y2:15}),
          h('line',{x1:17,y1:9,x2:23,y2:15})
        ),
        trash: h('svg', {width:16,height:16,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2},
          h('polyline',{points:'3 6 5 6 21 6'}),
          h('path',{d:'M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2'})
        ),
        book: h('svg', {width:24,height:24,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:2},
          h('path',{d:'M4 19.5A2.5 2.5 0 0 1 6.5 17H20'}),
          h('path',{d:'M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z'})
        )
      };

      // LOGIN VIEW
      if (view === 'login') {
        return h('div', {className:'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4'},
          h('div', {className:'bg-white rounded-2xl shadow-xl p-8 w-full max-w-md'},
            h('div', {className:'text-center mb-8'},
              h('div', {className:'bg-indigo-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4'}, icons.users),
              h('h1', {className:'text-3xl font-bold text-gray-800'}, 'Sunday School Exam'),
              h('p', {className:'text-gray-600 mt-2'}, 'Enter your name to begin')
            ),
            h('div', null,
              h('input', {
                type:'text',
                value:studentName,
                onChange:(e)=>setStudentName(e.target.value),
                placeholder:'Your Full Name',
                className:'w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 mb-4',
                onKeyPress:(e)=>e.key==='Enter'&&handleLogin()
              }),
              h('button', {
                onClick:handleLogin,
                className:'w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition'
              }, 'Continue')
            ),
            h('p', {className:'text-sm text-gray-500 text-center mt-4'}, 'Type "admin" to access teacher dashboard')
          )
        );
      }

      // EXAM SELECTION VIEW
      if (view === 'exam-selection') {
        return h('div', {className:'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4'},
          h('div', {className:'bg-white rounded-2xl shadow-xl p-8 w-full max-w-md'},
            h('div', {className:'text-center mb-8'},
              h('div', {className:'bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4'}, icons.book),
              h('h2', {className:'text-2xl font-bold text-gray-800'}, 'Select Exam'),
              h('p', {className:'text-gray-600 mt-2'}, 'Hello, ' + studentName + '!'),
              h('p', {className:'text-sm text-gray-500 mt-1'}, 'Enter the exam name provided by your teacher')
            ),
            h('div', null,
              h('input', {
                type:'text',
                value:examName,
                onChange:(e)=>setExamName(e.target.value),
                placeholder:'Exam Name (e.g., genesis-quiz)',
                className:'w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-green-500 mb-4',
                onKeyPress:(e)=>e.key==='Enter'&&handleExamSelection()
              }),
              h('button', {
                onClick:handleExamSelection,
                className:'w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition mb-2'
              }, 'Start Exam'),
              h('button', {
                onClick:resetApp,
                className:'w-full px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50'
              }, 'Back')
            ),
            h('div', {className:'mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4'},
              h('p', {className:'text-xs text-blue-800 font-semibold mb-2'}, 'ðŸ’¡ Tip: Ask your teacher for the exam name'),
              h('p', {className:'text-xs text-blue-600'}, 'Exam names are usually lowercase with dashes (e.g., genesis-quiz, hebrews-chapter-1)')
            )
          )
        );
      }

      // ADMIN PASSWORD VIEW
      if (view === 'admin-password') {
        return h('div', {className:'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4'},
          h('div', {className:'bg-white rounded-2xl shadow-xl p-8 w-full max-w-md'},
            h('div', {className:'text-center mb-8'},
              h('div', {className:'bg-red-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4'}, icons.alert),
              h('h2', {className:'text-2xl font-bold text-gray-800'}, 'Admin Access'),
              h('p', {className:'text-gray-600 mt-2'}, 'Enter admin password')
            ),
            h('div', null,
              h('input', {
                type:'password',
                value:passwordInput,
                onChange:(e)=>setPasswordInput(e.target.value),
                placeholder:'Password',
                className:'w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 mb-4',
                onKeyPress:(e)=>e.key==='Enter'&&handleAdminLogin()
              }),
              h('button', {
                onClick:handleAdminLogin,
                className:'w-full bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition mb-2'
              }, 'Login as Admin'),
              h('button', {
                onClick:resetApp,
                className:'w-full px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50'
              }, 'Back')
            )
          )
        );
      }

      // ADMIN DASHBOARD
      if (view === 'admin' && isAdmin) {
        return h('div', {className:'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4'},
          h('div', {className:'max-w-6xl mx-auto'},
            h('div', {className:'bg-white rounded-2xl shadow-xl p-8'},
              // Header Section
              h('div', {className:'flex justify-between items-center mb-6'},
                h('h1', {className:'text-3xl font-bold text-gray-800'}, 'Teacher Dashboard'),
                h('button', {onClick:resetApp,className:'px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600'}, 'Logout')
              ),

              // Token Setup Section (MOVED OUTSIDE HEADER)
              !githubToken && h('div', {className:'bg-red-50 border-2 border-red-200 rounded-xl p-6 mb-6'},
                h('h2', {className:'text-xl font-bold text-red-800 mb-4'}, 'ðŸ” GitHub Token Required'),
                h('p', {className:'text-sm text-gray-700 mb-4'}, 'To upload exams to GitHub, you need to enter your Personal Access Token once. It will be saved securely in your browser.'),
                h('input', {
                  type:'password',
                  value:githubToken,
                  onChange:(e)=>setGithubToken(e.target.value),
                  placeholder:'Paste your GitHub token here',
                  className:'w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-500 mb-3'
                }),
                h('button', {
                  onClick:()=>{
                    if(githubToken.trim()){
                      setGitHubToken(githubToken);
                      alert('Token saved successfully! You can now upload exams.');
                    }
                  },
                  className:'w-full bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700'
                }, 'Save Token')
              ),
              
              // Upload Section
              h('div', {className:'bg-blue-50 border-2 border-blue-200 rounded-xl p-6 mb-6'},
                h('h2', {className:'text-xl font-bold text-gray-800 mb-4'}, 'ðŸ“¤ Upload Exam to GitHub'),
                h('div', {className:'bg-white rounded-lg p-4 mb-4'},
                  h('p', {className:'text-sm text-gray-600 mb-3'}, 'Upload a JSON file containing exam questions. It will be stored in GitHub for all students to access.'),
                  isUploading && h('div', {className:'mb-3'},
                    h('p', {className:'text-indigo-600 font-semibold'}, 'â³ Uploading to GitHub...')
                  ),
                  h('label', {className:'block'},
                    h('div', {className:'flex items-center gap-2 mb-2'},
                      icons.upload,
                      h('span', {className:'font-semibold text-gray-700'}, 'Select Exam JSON File')
                    ),
                    h('input', {
                      type:'file',
                      accept:'.json',
                      onChange:handleFileUpload,
                      disabled:isUploading,
                      className:'block w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer disabled:opacity-50'
                    })
                  )
                )
              ),

              // Available Exams Section
              availableExams.length > 0 && h('div', {className:'bg-purple-50 border-2 border-purple-200 rounded-xl p-6 mb-6'},
                h('div', {className:'flex justify-between items-center mb-4'},
                  h('h2', {className:'text-xl font-bold text-gray-800'}, 'ðŸ“š Available Exams on GitHub'),
                  h('button', {
                    onClick:fetchAvailableExams,
                    className:'px-3 py-1 text-sm bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200'
                  }, 'ðŸ”„ Refresh')
                ),
                h('div', {className:'bg-white rounded-lg p-4'},
                  h('div', {className:'grid gap-2'},
                    availableExams.map((exam, idx) =>
                      h('div', {key:idx, className:'flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200'},
                        h('div', null,
                          h('p', {className:'font-semibold text-gray-800'}, exam.name),
                          h('p', {className:'text-xs text-gray-500'}, 'Students should enter: ' + exam.name)
                        ),
                        h('span', {className:'text-green-600 text-sm'}, 'âœ“ Available')
                      )
                    )
                  )
                )
              ),
              
              // Results Section
              h('div', {className:'bg-green-50 border-2 border-green-200 rounded-xl p-6'},
                h('div', {className:'flex justify-between items-center mb-4'},
                  h('h2', {className:'text-xl font-bold text-gray-800'}, 'ðŸ“Š Student Results'),
                  allResults.length > 0 && h('div', {className:'flex gap-2'},
                    h('button', {onClick:exportToExcel,className:'flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700'},
                      icons.download, ' Export Excel'
                    ),
                    h('button', {onClick:clearAllResults,className:'flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700'},
                      icons.trash, ' Clear All'
                    )
                  )
                ),
                allResults.length === 0 ? h('div', {className:'text-center py-12'},
                  h('div', {className:'mx-auto mb-4 text-gray-400'}, icons.alert),
                  h('p', {className:'text-gray-500 text-lg'}, 'No student results yet')
                ) : h('div', {className:'bg-white rounded-lg overflow-hidden'},
                  h('div', {className:'overflow-x-auto'},
                    h('table', {className:'w-full'},
                      h('thead', {className:'bg-gray-100'},
                        h('tr', null,
                          h('th', {className:'px-4 py-3 text-left font-semibold'}, 'Rank'),
                          h('th', {className:'px-4 py-3 text-left font-semibold'}, 'Student Name'),
                          h('th', {className:'px-4 py-3 text-left font-semibold'}, 'Exam Name'),
                          h('th', {className:'px-4 py-3 text-left font-semibold'}, 'Marks'),
                          h('th', {className:'px-4 py-3 text-left font-semibold'}, 'Percentage'),
                          h('th', {className:'px-4 py-3 text-left font-semibold'}, 'Date & Time')
                        )
                      ),
                      h('tbody', null,
                        allResults.sort((a,b)=>a.rank-b.rank).map((result,idx)=>
                          h('tr', {key:idx,className:'border-b hover:bg-gray-50'},
                            h('td', {className:'px-4 py-3'},
                              h('span', {className:`font-bold ${result.rank===1?'text-yellow-600':result.rank===2?'text-gray-500':result.rank===3?'text-orange-600':'text-gray-800'}`},
                                '#' + result.rank
                              )
                            ),
                            h('td', {className:'px-4 py-3 font-medium'}, result.studentName),
                            h('td', {className:'px-4 py-3 text-gray-600'}, result.examName),
                            h('td', {className:'px-4 py-3 font-semibold'}, result.marks),
                            h('td', {className:'px-4 py-3'},
                              h('span', {className:`font-semibold ${parseFloat(result.percentage)>=70?'text-green-600':parseFloat(result.percentage)>=50?'text-yellow-600':'text-red-600'}`},
                                result.percentage + '%'
                              )
                            ),
                            h('td', {className:'px-4 py-3 text-sm text-gray-600'}, result.timestamp)
                          )
                        )
                      )
                    )
                  )
                )
              ),

              // GitHub Setup Info
              h('div', {className:'mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4'},
                h('p', {className:'text-xs text-yellow-800 font-semibold mb-2'}, 'âš™ï¸ GitHub Configuration'),
                h('p', {className:'text-xs text-yellow-700'}, `Repository: ${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}`),
                h('p', {className:'text-xs text-yellow-700'}, `Branch: ${GITHUB_CONFIG.branch}`),
                h('p', {className:'text-xs text-yellow-700 mt-2'}, githubToken ? 'âœ“ Token configured' : 'âš ï¸ Please enter your GitHub token above')
              )
            )
          )
        );
      }

      // EXAM VIEW
      if (view === 'exam' && examData) {
        const question = examData.questions[currentQuestion];
        const progress = ((currentQuestion + 1) / examData.questions.length) * 100;

        return h('div', {className:'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4'},
          h('div', {className:'max-w-4xl mx-auto'},
            h('div', {className:'bg-white rounded-t-2xl shadow-xl p-6'},
              h('div', {className:'flex justify-between items-center mb-4'},
                h('div', null,
                  h('h2', {className:'text-2xl font-bold text-gray-800'}, examData.examName),
                  h('p', {className:'text-gray-600'}, 'Student: ' + studentName)
                ),
                h('div', {className:'flex items-center gap-2 bg-red-100 px-4 py-2 rounded-lg'},
                  icons.clock,
                  h('span', {className:'text-2xl font-bold text-red-600'}, formatTime(timeLeft))
                )
              ),
              h('div', {className:'w-full bg-gray-200 rounded-full h-2'},
                h('div', {className:'bg-indigo-600 h-2 rounded-full transition-all',style:{width:progress+'%'}})
              ),
              h('p', {className:'text-sm text-gray-600 mt-2'}, `Question ${currentQuestion + 1} of ${examData.questions.length}`)
            ),
            h('div', {className:'bg-white shadow-xl p-8 mb-4'},
              h('div', {className:'flex items-start justify-between gap-4 mb-6'},
                h('h3', {className:'text-xl font-semibold text-gray-800 flex-1'}, question.question),
                h('button', {
                  onClick:()=>speakQuestion(question.question),
                  className:`flex-shrink-0 p-3 rounded-full transition ${isSpeaking?'bg-red-100 hover:bg-red-200':'bg-indigo-100 hover:bg-indigo-200'}`,
                  title:isSpeaking?'Stop reading':'Read question aloud'
                }, isSpeaking ? icons.volumeX : icons.volume)
              ),
              h('div', {className:'space-y-3'},
                question.options.map((option,idx)=>
                  h('button', {
                    key:idx,
                    onClick:()=>handleAnswerSelect(currentQuestion,idx),
                    className:`w-full text-left px-6 py-4 rounded-lg border-2 transition ${answers[currentQuestion]===idx?'border-indigo-600 bg-indigo-50 font-semibold':'border-gray-300 hover:border-indigo-300 hover:bg-gray-50'}`
                  },
                    h('span', {className:'font-semibold text-indigo-600 mr-3'}, String.fromCharCode(65+idx)+'.'),
                    option
                  )
                )
              )
            ),
            h('div', {className:'bg-white rounded-b-2xl shadow-xl p-6 flex justify-between'},
              h('button', {
                onClick:()=>setCurrentQuestion(Math.max(0,currentQuestion-1)),
                disabled:currentQuestion===0,
                className:'px-6 py-2 bg-gray-300 text-gray-700 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-400'
              }, 'Previous'),
              currentQuestion < examData.questions.length-1 ?
                h('button', {
                  onClick:()=>setCurrentQuestion(currentQuestion+1),
                  className:'px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700'
                }, 'Next') :
                h('button', {
                  onClick:handleSubmit,
                  className:'px-6 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 flex items-center gap-2'
                }, icons.check, ' Submit Exam')
            )
          )
        );
      }

      // RESULTS VIEW
      if (view === 'results') {
        const result = calculateScore();
        const myResult = allResults.find(r => 
          r.studentName === studentName && 
          r.examName === (examData?.examName || 'Untitled Exam')
        );

        return h('div', {className:'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4'},
          h('div', {className:'bg-white rounded-2xl shadow-xl p-8 w-full max-w-2xl'},
            h('div', {className:'text-center mb-8'},
              h('div', {className:`w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4 ${
                Number(result?.percentage) >= 70 ? 'bg-green-100' : Number(result?.percentage) >= 50 ? 'bg-yellow-100' : 'bg-red-100'
              }`}, 
                icons.check
              ),
              h('h2', {className:'text-3xl font-bold text-gray-800 mb-2'}, 'Exam Completed!'),
              h('p', {className:'text-gray-600'}, studentName)
            ),
            h('div', {className:'bg-gray-50 rounded-xl p-6 mb-6'},
              h('div', {className:'grid grid-cols-2 md:grid-cols-4 gap-6'},
                h('div', {className:'text-center'},
                  h('p', {className:'text-gray-600 mb-2'}, 'Score'),
                  h('p', {className:'text-3xl font-bold text-indigo-600'}, `${result?.score || 0}/${result?.total || 0}`)
                ),
                h('div', {className:'text-center'},
                  h('p', {className:'text-gray-600 mb-2'}, 'Percentage'),
                  h('p', {className:'text-3xl font-bold text-indigo-600'}, `${Number(result?.percentage) || 0}%`)
                ),
                h('div', {className:'text-center'},
                  h('p', {className:'text-gray-600 mb-2'}, 'Exam'),
                  h('p', {className:'text-lg font-semibold text-gray-800'}, examData?.examName || 'Unknown Exam')
                ),
                h('div', {className:'text-center'},
                  h('p', {className:'text-gray-600 mb-2'}, 'Your Rank'),
                  h('p', {className:'text-3xl font-bold text-purple-600'}, '#'+(myResult?.rank || '-'))
                )
              )
            ),
            h('button', {
              onClick:resetApp,
              className:'w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700'
            }, 'Back to Home')
          )
        );
      }

      return null;
    }

    const root = createRoot(document.getElementById('root'));
    root.render(h(ExamSystem));
  </script>
</body>
</html>
